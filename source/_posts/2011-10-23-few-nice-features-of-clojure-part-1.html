---
layout: post
title: "A Few Nice Features Of Clojure, Part #1: Using Macros To Freeze Time"
date: 2011-10-23T18:25:00-07:00
comments: false
categories:
 - clojure
---

<div class='post'>
<div style="color: black; font-family: Arial,Helvetica,sans-serif;"></div><div style="color: black; font-family: Arial,Helvetica,sans-serif;">I thought it might be fun to show some of Clojure's features off by taking a look at how I use some of them in my own project <a href="https://github.com/AlexBaranosky/EmailClojMatic">EmailClojMatic</a>.&nbsp; I've got 4 features in mind and will show one feature each post.<br /><br /><b>Problem #1:</b><br /><br />We want to unit test a function that depends on the current date.<br /><br /><b>Solution #1:</b><br /><br />Fortunately we are using <a href="http://joda-time.sourceforge.net/">JodaTime</a>, a great Java date/time library.&nbsp; JodaTime has built in features for setting the 'now' time.&nbsp; Let's use those to create a function to wrap our test code in, that will set the time at a given DateTime.<br /><br /><pre class="brush: clj; gutter: false;">(defn do-at* [date-time f]<br />  (DateTimeUtils/setCurrentMillisFixed (.getMillis date-time))<br />  (try<br />    (f)<br />    (finally (DateTimeUtils/setCurrentMillisSystem))))<br /><br />;; you might use this code like this:<br /><br />(do-at* (DateMidnight. 2000 1 1)<br />  (fn [] (DateMidnight.))) ;;=> (DateMidnight. 2000 1 1)<br /></pre><br />If you are like me and you find yourself writing test code using this construct frequently you can use Clojure's macro functionality to essentially extend the Clojure language to have a new feature for evaluating an expression at a given DateTime.&nbsp; This way we won't have to always wrap the expression in a function like we are doing in the do-at* function.<br /><br />Let's see the macro version that I decided to call `do-at`, because it is just like the built in Clojure function `do` except it evaluates at the given time. [It's probably worth noting that xyz* function with xyz companion macro is a common Clojure idiom. -@darevay]</div><br /><pre class="brush: clj; gutter: false;">(defmacro do-at [date-time & body]<br />  "like clojure.core.do except evalautes the<br />  expression at the given time"<br />  `(do-at* ~date-time<br />    (fn [] ~@body)))<br /><br />;; nice. Now we can see the actual code that was hiding<br />;; behind all of those parens and fn creation:<br /><br />(do-at (DateMidnight. 2000 1 1)<br />  (DateMidnight.)) ;;=> (DateMidnight. 2000 1 1)<br /></pre><br /><div style="color: black; font-family: Arial,Helvetica,sans-serif;">It's pretty powerful the way that macros give you the ability to shape your library so that it is free of boiler plate.</div></div>
